# 企业微信健康社群系统 - 部署配置指南

## 一、企业微信后台配置

### 1.1 创建自建应用

1. 登录企业微信管理后台：https://work.weixin.qq.com/wework_admin
2. 进入 **应用管理** → **自建** → **创建应用**
3. 填写应用信息：
   - 应用名称：健康社群助手
   - 应用介绍：提供健康管理、保险咨询、权益查询等服务
   - 应用图标：上传应用图标
4. 创建完成后记录：
   - AgentId：`1000007`
   - Secret：`x-3ikL_1L8FpaqgMTGYmVWwcFACTwmV8gW-h7hLqIoM`

### 1.2 配置网页授权及JS-SDK

1. 进入应用详情页 → **网页授权及JS-SDK**
2. 设置 **可信域名**：
   - 填写您的域名，如：`healthcare.yourdomain.com`
   - 需要配置校验文件到服务器根目录
3. 设置 **应用主页**：
   - 移动端主页：`https://your-domain/sidebar`
   - 桌面端主页：`https://your-domain/customer-service`

### 1.3 配置接收消息

1. 进入应用详情页 → **接收消息** → **设置API接收**
2. 填写配置信息：
   - URL：`https://your-domain/api/v1/wechat/callback`
   - Token：`IlXP1Nd8pFlHfcl`
   - EncodingAESKey：`Tr2NfsFeAjsyKMP5e5u7HqoyNMYWeP4wyXTO5G4t0Ir`
   - 消息加解密方式：推荐选择 **安全模式**
3. 点击保存，验证服务器地址有效性

### 1.4 配置客户联系权限

1. 进入 **客户联系** → **权限配置**
2. 确保应用有权限使用以下接口：
   - 获取客户列表
   - 获取客户详情
   - 发送消息到客户
   - 获取客户群列表

### 1.5 配置侧边栏

1. 进入 **客户联系** → **聊天工具栏管理**
2. 点击 **配置应用页面**
3. 填写页面配置：
   - 页面名称：健康助手
   - 页面URL：`https://your-domain/sidebar`
   - 配置到：客户联系聊天工具栏

## 二、服务器部署配置

### 2.1 环境要求

- JDK 17+
- MySQL 8.0+
- Redis 6.0+
- Nginx（推荐用于反向代理和HTTPS）

### 2.2 数据库初始化

```bash
# 登录MySQL
mysql -u root -p

# 创建数据库
CREATE DATABASE healthcare_bbc DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;

# 执行初始化脚本
use healthcare_bbc;
source /path/to/schema.sql;
```

### 2.3 后端服务部署

#### 2.3.1 配置文件

编辑 `application.yml`：

```yaml
server:
  port: 8080

spring:
  datasource:
    url: jdbc:mysql://localhost:3306/healthcare_bbc?useUnicode=true&characterEncoding=utf-8&useSSL=false&serverTimezone=Asia/Shanghai
    username: your_db_username
    password: your_db_password
  
  redis:
    host: localhost
    port: 6379

wechat:
  work:
    corp-id: wwace533e386c63f72
    corp-secret: x-3ikL_1L8FpaqgMTGYmVWwcFACTwmV8gW-h7hLqIoM
    agent-id: 1000007
    token: IlXP1Nd8pFlHfcl
    encoding-aes-key: Tr2NfsFeAjsyKMP5e5u7HqoyNMYWeP4wyXTO5G4t0Ir
```

#### 2.3.2 启动服务

```bash
# 使用Maven打包
cd backend
mvn clean package -DskipTests

# 运行
java -jar target/healthcare-bbc-0.0.1-SNAPSHOT.jar
```

### 2.4 前端部署

#### 2.4.1 构建

```bash
cd frontend
npm install
npm run build
```

#### 2.4.2 Nginx配置

```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    # 重定向到HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl;
    server_name your-domain.com;
    
    ssl_certificate /path/to/your/certificate.crt;
    ssl_certificate_key /path/to/your/private.key;
    
    # 前端静态资源
    location / {
        root /path/to/frontend/dist;
        try_files $uri $uri/ /index.html;
    }
    
    # 后端API代理
    location /api/ {
        proxy_pass http://localhost:8080/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

## 三、验证配置

### 3.1 后端服务验证

1. 访问 Swagger 文档：`https://your-domain/swagger-ui.html`
2. 测试企业微信回调接口
3. 测试JS-SDK配置接口：`GET /api/v1/wechat/js-sdk/config?url=xxx`

### 3.2 前端页面验证

1. 访问客服工作台：`https://your-domain/customer-service`
2. 访问侧边栏页面：`https://your-domain/sidebar`

### 3.3 企业微信集成验证

1. 在企业微信中打开侧边栏
2. 验证是否能正确识别客户ID
3. 测试发送快捷回复
4. 测试AI助手功能

## 四、常见问题

### 4.1 回调URL验证失败

- 检查服务器是否能被公网访问
- 确认Token和EncodingAESKey配置正确
- 查看后端日志排查错误

### 4.2 JS-SDK初始化失败

- 确认可信域名已正确配置
- 检查jsapi_ticket获取是否正常
- 确认签名算法正确

### 4.3 无法获取客户ID

- 确认应用有客户联系权限
- 检查是否在正确的聊天场景中（客户联系）
- 验证JS-SDK配置是否正确

## 五、安全配置建议

1. **启用HTTPS**：所有通信必须使用HTTPS
2. **配置防火墙**：仅开放必要的端口（80、443）
3. **定期更换密钥**：建议定期更换Secret和EncodingAESKey
4. **日志监控**：配置日志监控和告警
5. **数据备份**：定期备份数据库

## 六、联系方式

如有问题，请联系技术团队。
