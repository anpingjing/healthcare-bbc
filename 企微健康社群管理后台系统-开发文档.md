# 企微健康社群管理后台系统 - 开发文档

**文档版本**：V1.0  
**编制日期**：2026-02-04  
**编制人员**：技术团队  

---

## 目录

1. [概述](#1-概述)
2. [技术架构](#2-技术架构)
3. [数据库设计](#3-数据库设计)
4. [接口设计](#4-接口设计)
5. [核心功能开发指南](#5-核心功能开发指南)
6. [安全设计](#6-安全设计)
7. [部署方案](#7-部署方案)
8. [开发规范](#8-开发规范)
9. [测试方案](#9-测试方案)
10. [附录](#10-附录)

---

## 1. 概述

### 1.1 文档目的

本文档为企微健康社群管理后台系统的技术开发文档，旨在为开发团队提供详细的技术指导，包括系统架构、数据库设计、接口规范、开发规范等内容。

### 1.2 系统简介

企微健康社群管理后台系统是基于企业微信生态的健康管理服务平台，支持4R角色（家庭医生、健康管家、权益顾问、保险顾问）协同服务，提供社群管理、用户管理、API管理、数据统计等功能。

### 1.3 技术栈

#### 1.3.1 后端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| Java | 17 | 开发语言 |
| Spring Boot | 3.2.x | 应用框架 |
| Spring Security | 6.x | 安全框架 |
| MyBatis Plus | 3.5.x | ORM框架 |
| MySQL | 8.0 | 关系型数据库 |
| Redis | 7.x | 缓存数据库 |
| RabbitMQ | 3.12.x | 消息队列 |
| Elasticsearch | 8.x | 搜索引擎 |
| JWT | 0.12.x | 身份认证 |
| Swagger | 3.x | 接口文档 |

#### 1.3.2 前端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| Vue.js | 3.4.x | 前端框架 |
| TypeScript | 5.x | 开发语言 |
| Element Plus | 2.5.x | UI组件库 |
| Pinia | 2.x | 状态管理 |
| Vue Router | 4.x | 路由管理 |
| Axios | 1.6.x | HTTP客户端 |
| ECharts | 5.x | 图表库 |
| Vite | 5.x | 构建工具 |

---

## 2. 技术架构

### 2.1 系统架构图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              前端层 (Frontend)                           │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐   │
│  │   Web管理端   │ │   移动端H5    │ │   企微侧边栏  │ │   数据大屏    │   │
│  │   (Vue3)     │ │   (Vue3)     │ │   (Vue3)     │ │   (Vue3)     │   │
│  └──────────────┘ └──────────────┘ └──────────────┘ └──────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                           网关层 (Gateway)                               │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  Spring Cloud Gateway                                           │   │
│  │  - 路由转发  - 负载均衡  - 限流熔断  - 日志记录                    │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                           服务层 (Service)                               │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐     │
│  │ 用户服务  │ │ 社群服务  │ │ API服务  │ │ 数据统计  │ │ 系统服务  │     │
│  │ (User)   │ │ (Group)  │ │ (API)    │ │ (Stats)  │ │ (System) │     │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘     │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐                   │
│  │ 权限服务  │ │ 消息服务  │ │ 文件服务  │ │ 企微服务  │                   │
│  │ (Auth)   │ │ (Message)│ │ (File)   │ │ (Wechat) │                   │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘                   │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                           数据层 (Data)                                  │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐     │
│  │   MySQL  │ │   Redis  │ │  RabbitMQ│ │    ES    │ │  MinIO   │     │
│  │ 业务数据  │ │ 缓存会话  │ │ 消息队列  │ │ 搜索引擎  │ │ 文件存储  │     │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘     │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.2 模块划分

#### 2.2.1 用户权限模块 (admin-user)

**职责**：用户管理、角色管理、权限管理、组织架构管理

**核心功能**：
- 用户CRUD操作
- 角色定义与权限分配
- RBAC权限校验
- 登录认证与会话管理

**依赖服务**：无

#### 2.2.2 社群管理模块 (admin-group)

**职责**：社群生命周期管理、成员管理、内容管理

**核心功能**：
- 社群创建、编辑、解散
- 成员添加、移除、禁言
- 消息内容审核
- 关键词回复配置

**依赖服务**：用户服务、企微服务、消息服务

#### 2.2.3 API管理模块 (admin-api)

**职责**：API接口管理、在线测试、文档生成

**核心功能**：
- API信息录入与维护
- 在线接口测试
- 文档自动生成
- 调用统计分析

**依赖服务**：无

#### 2.2.4 数据统计模块 (admin-stats)

**职责**：数据统计、报表生成、数据大屏

**核心功能**：
- 用户数据统计
- 社群活跃度统计
- 业务指标统计
- 报表导出

**依赖服务**：用户服务、社群服务

#### 2.2.5 系统服务模块 (admin-system)

**职责**：系统配置、日志管理、文件管理

**核心功能**：
- 系统参数配置
- 操作日志记录
- 文件上传下载
- 缓存管理

**依赖服务**：无

#### 2.2.6 企微服务模块 (admin-wechat)

**职责**：企业微信API对接、消息推送

**核心功能**：
- 企微API调用
- 消息回调处理
- 群消息发送
- 客户联系管理

**依赖服务**：无

### 2.3 项目结构

```
healthcare-admin/
├── healthcare-admin-common/          # 公共模块
│   ├── src/main/java/
│   │   └── com/healthcare/admin/common/
│   │       ├── constant/             # 常量定义
│   │       ├── enums/                # 枚举类
│   │       ├── exception/            # 异常类
│   │       ├── result/               # 统一响应
│   │       └── utils/                # 工具类
│   └── pom.xml
│
├── healthcare-admin-gateway/         # 网关服务
│   ├── src/main/java/
│   │   └── com/healthcare/admin/gateway/
│   │       ├── config/               # 网关配置
│   │       ├── filter/               # 过滤器
│   │       └── handler/              # 异常处理
│   └── pom.xml
│
├── healthcare-admin-user/            # 用户服务
│   ├── src/main/java/
│   │   └── com/healthcare/admin/user/
│   │       ├── controller/           # 控制器
│   │       ├── service/              # 服务层
│   │       ├── mapper/               # 数据访问层
│   │       ├── entity/               # 实体类
│   │       ├── dto/                  # 数据传输对象
│   │       └── vo/                   # 视图对象
│   └── pom.xml
│
├── healthcare-admin-group/           # 社群服务
├── healthcare-admin-api/             # API管理服务
├── healthcare-admin-stats/           # 统计服务
├── healthcare-admin-system/          # 系统服务
├── healthcare-admin-wechat/          # 企微服务
│
├── healthcare-admin-ui/              # 前端项目
│   ├── src/
│   │   ├── api/                      # API接口
│   │   ├── views/                    # 页面组件
│   │   ├── components/               # 公共组件
│   │   ├── store/                    # 状态管理
│   │   ├── router/                   # 路由配置
│   │   └── utils/                    # 工具函数
│   └── package.json
│
└── pom.xml                           # 父POM
```

---

## 3. 数据库设计

### 3.1 数据库选型

| 数据库 | 用途 | 版本 |
|--------|------|------|
| MySQL | 业务数据存储 | 8.0 |
| Redis | 缓存、会话、分布式锁 | 7.x |
| Elasticsearch | 日志检索、全文搜索 | 8.x |
| MinIO | 文件存储 | 最新版 |

### 3.2 核心表结构

#### 3.2.1 用户权限相关表

##### 用户表 (sys_user)

```sql
CREATE TABLE sys_user (
    user_id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '用户ID',
    username VARCHAR(64) NOT NULL UNIQUE COMMENT '用户名',
    password VARCHAR(128) NOT NULL COMMENT '密码',
    real_name VARCHAR(64) COMMENT '真实姓名',
    phone VARCHAR(16) COMMENT '手机号',
    email VARCHAR(64) COMMENT '邮箱',
    avatar VARCHAR(255) COMMENT '头像URL',
    gender TINYINT DEFAULT 0 COMMENT '性别: 0-未知 1-男 2-女',
    dept_id BIGINT COMMENT '部门ID',
    status TINYINT DEFAULT 1 COMMENT '状态: 0-禁用 1-正常 2-锁定',
    login_ip VARCHAR(64) COMMENT '最后登录IP',
    login_time DATETIME COMMENT '最后登录时间',
    wechat_user_id VARCHAR(64) COMMENT '企微用户ID',
    remark VARCHAR(255) COMMENT '备注',
    create_by BIGINT COMMENT '创建人',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_by BIGINT COMMENT '更新人',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    deleted TINYINT DEFAULT 0 COMMENT '删除标志: 0-未删除 1-已删除',
    INDEX idx_username (username),
    INDEX idx_phone (phone),
    INDEX idx_dept_id (dept_id),
    INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户表';
```

##### 角色表 (sys_role)

```sql
CREATE TABLE sys_role (
    role_id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '角色ID',
    role_code VARCHAR(64) NOT NULL UNIQUE COMMENT '角色编码',
    role_name VARCHAR(64) NOT NULL COMMENT '角色名称',
    role_type TINYINT DEFAULT 1 COMMENT '角色类型: 1-系统预设 2-自定义',
    data_scope TINYINT DEFAULT 1 COMMENT '数据范围: 1-全部 2-部门 3-个人 4-自定义',
    description VARCHAR(255) COMMENT '角色描述',
    sort_order INT DEFAULT 0 COMMENT '排序',
    status TINYINT DEFAULT 1 COMMENT '状态: 0-禁用 1-启用',
    create_by BIGINT COMMENT '创建人',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_by BIGINT COMMENT '更新人',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    deleted TINYINT DEFAULT 0 COMMENT '删除标志',
    INDEX idx_role_code (role_code),
    INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='角色表';
```

##### 用户角色关联表 (sys_user_role)

```sql
CREATE TABLE sys_user_role (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL COMMENT '用户ID',
    role_id BIGINT NOT NULL COMMENT '角色ID',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    UNIQUE KEY uk_user_role (user_id, role_id),
    INDEX idx_user_id (user_id),
    INDEX idx_role_id (role_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户角色关联表';
```

##### 权限表 (sys_permission)

```sql
CREATE TABLE sys_permission (
    permission_id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '权限ID',
    parent_id BIGINT DEFAULT 0 COMMENT '父权限ID',
    permission_code VARCHAR(128) NOT NULL UNIQUE COMMENT '权限编码',
    permission_name VARCHAR(64) NOT NULL COMMENT '权限名称',
    permission_type TINYINT NOT NULL COMMENT '权限类型: 1-目录 2-菜单 3-按钮 4-接口',
    path VARCHAR(128) COMMENT '路由路径',
    component VARCHAR(128) COMMENT '组件路径',
    icon VARCHAR(64) COMMENT '图标',
    sort_order INT DEFAULT 0 COMMENT '排序',
    status TINYINT DEFAULT 1 COMMENT '状态: 0-禁用 1-启用',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    INDEX idx_parent_id (parent_id),
    INDEX idx_permission_type (permission_type),
    INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='权限表';
```

##### 角色权限关联表 (sys_role_permission)

```sql
CREATE TABLE sys_role_permission (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    role_id BIGINT NOT NULL COMMENT '角色ID',
    permission_id BIGINT NOT NULL COMMENT '权限ID',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    UNIQUE KEY uk_role_permission (role_id, permission_id),
    INDEX idx_role_id (role_id),
    INDEX idx_permission_id (permission_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='角色权限关联表';
```

##### 部门表 (sys_dept)

```sql
CREATE TABLE sys_dept (
    dept_id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '部门ID',
    parent_id BIGINT DEFAULT 0 COMMENT '父部门ID',
    dept_name VARCHAR(64) NOT NULL COMMENT '部门名称',
    dept_code VARCHAR(64) COMMENT '部门编码',
    leader_id BIGINT COMMENT '负责人ID',
    phone VARCHAR(16) COMMENT '联系电话',
    email VARCHAR(64) COMMENT '邮箱',
    sort_order INT DEFAULT 0 COMMENT '排序',
    status TINYINT DEFAULT 1 COMMENT '状态: 0-禁用 1-启用',
    create_by BIGINT COMMENT '创建人',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_by BIGINT COMMENT '更新人',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    deleted TINYINT DEFAULT 0 COMMENT '删除标志',
    INDEX idx_parent_id (parent_id),
    INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='部门表';
```

##### 操作日志表 (sys_operation_log)

```sql
CREATE TABLE sys_operation_log (
    log_id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '日志ID',
    user_id BIGINT COMMENT '用户ID',
    username VARCHAR(64) COMMENT '用户名',
    operation_type VARCHAR(32) COMMENT '操作类型',
    module VARCHAR(64) COMMENT '操作模块',
    description VARCHAR(255) COMMENT '操作描述',
    request_method VARCHAR(16) COMMENT '请求方法',
    request_url VARCHAR(255) COMMENT '请求URL',
    request_params TEXT COMMENT '请求参数',
    response_data TEXT COMMENT '响应数据',
    ip_address VARCHAR(64) COMMENT 'IP地址',
    user_agent VARCHAR(255) COMMENT '浏览器UA',
    execution_time INT COMMENT '执行时长(ms)',
    status TINYINT COMMENT '状态: 0-失败 1-成功',
    error_msg TEXT COMMENT '错误信息',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    INDEX idx_user_id (user_id),
    INDEX idx_module (module),
    INDEX idx_create_time (create_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='操作日志表';
```

#### 3.2.2 社群管理相关表

##### 社群表 (group_info)

```sql
CREATE TABLE group_info (
    group_id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '社群ID',
    group_name VARCHAR(128) NOT NULL COMMENT '社群名称',
    group_type TINYINT NOT NULL COMMENT '社群类型: 1-健康交流 2-慢病管理 3-保险服务 4-综合',
    chat_id VARCHAR(128) COMMENT '企微群ID',
    owner_id BIGINT COMMENT '群主ID',
    description TEXT COMMENT '社群描述',
    avatar VARCHAR(255) COMMENT '社群头像',
    max_members INT DEFAULT 500 COMMENT '最大成员数',
    member_count INT DEFAULT 0 COMMENT '当前成员数',
    
    -- 4R角色配置
    doctor_id BIGINT COMMENT '家庭医生ID',
    health_manager_id BIGINT COMMENT '健康管家ID',
    benefit_advisor_id BIGINT COMMENT '权益顾问ID',
    insurance_advisor_id BIGINT COMMENT '保险顾问ID',
    
    -- 入群配置
    join_type TINYINT DEFAULT 1 COMMENT '入群方式: 1-自动通过 2-需要审核',
    welcome_msg TEXT COMMENT '欢迎语',
    welcome_form_id BIGINT COMMENT '入群表单ID',
    
    -- 规则配置
    mute_type TINYINT DEFAULT 0 COMMENT '禁言类型: 0-不禁言 1-全员禁言 2-定时禁言',
    mute_start_time TIME COMMENT '禁言开始时间',
    mute_end_time TIME COMMENT '禁言结束时间',
    ad_filter TINYINT DEFAULT 1 COMMENT '广告过滤: 0-关闭 1-开启',
    sensitive_words TEXT COMMENT '敏感词列表',
    
    status TINYINT DEFAULT 1 COMMENT '状态: 0-解散 1-正常 2-禁言',
    create_by BIGINT COMMENT '创建人',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_by BIGINT COMMENT '更新人',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    deleted TINYINT DEFAULT 0 COMMENT '删除标志',
    INDEX idx_group_type (group_type),
    INDEX idx_owner_id (owner_id),
    INDEX idx_status (status),
    INDEX idx_create_time (create_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='社群表';
```

##### 社群成员表 (group_member)

```sql
CREATE TABLE group_member (
    member_id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '成员ID',
    group_id BIGINT NOT NULL COMMENT '社群ID',
    user_id BIGINT COMMENT '用户ID',
    external_user_id VARCHAR(128) COMMENT '企微外部联系人ID',
    nickname VARCHAR(64) COMMENT '群昵称',
    role_type TINYINT DEFAULT 3 COMMENT '角色: 1-群主 2-管理员 3-成员',
    join_time DATETIME COMMENT '入群时间',
    join_scene TINYINT COMMENT '入群方式: 1-直接邀请 2-二维码 3-链接',
    inviter_id BIGINT COMMENT '邀请人ID',
    
    -- 用户标签
    health_tags VARCHAR(255) COMMENT '健康标签',
    policy_status TINYINT COMMENT '保单状态: 0-无 1-有',
    service_status TINYINT DEFAULT 1 COMMENT '服务状态: 0-停止 1-正常',
    
    -- 活跃度
    msg_count INT DEFAULT 0 COMMENT '发言次数',
    last_active_time DATETIME COMMENT '最后活跃时间',
    
    mute_end_time DATETIME COMMENT '禁言结束时间',
    status TINYINT DEFAULT 1 COMMENT '状态: 0-已退群 1-正常',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    UNIQUE KEY uk_group_user (group_id, user_id),
    INDEX idx_group_id (group_id),
    INDEX idx_user_id (user_id),
    INDEX idx_role_type (role_type),
    INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='社群成员表';
```

##### 社群标签表 (group_tag)

```sql
CREATE TABLE group_tag (
    tag_id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '标签ID',
    tag_name VARCHAR(64) NOT NULL COMMENT '标签名称',
    tag_color VARCHAR(16) DEFAULT '#1890FF' COMMENT '标签颜色',
    sort_order INT DEFAULT 0 COMMENT '排序',
    status TINYINT DEFAULT 1 COMMENT '状态: 0-禁用 1-启用',
    create_by BIGINT COMMENT '创建人',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_by BIGINT COMMENT '更新人',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    deleted TINYINT DEFAULT 0 COMMENT '删除标志',
    INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='社群标签表';
```

##### 社群标签关联表 (group_tag_rel)

```sql
CREATE TABLE group_tag_rel (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    group_id BIGINT NOT NULL COMMENT '社群ID',
    tag_id BIGINT NOT NULL COMMENT '标签ID',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    UNIQUE KEY uk_group_tag (group_id, tag_id),
    INDEX idx_group_id (group_id),
    INDEX idx_tag_id (tag_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='社群标签关联表';
```

##### 关键词回复表 (group_keyword_reply)

```sql
CREATE TABLE group_keyword_reply (
    reply_id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '回复ID',
    group_id BIGINT COMMENT '社群ID(0表示全局)',
    keyword VARCHAR(128) NOT NULL COMMENT '关键词',
    match_type TINYINT DEFAULT 1 COMMENT '匹配类型: 1-全词 2-包含 3-开头 4-结尾 5-正则',
    reply_type TINYINT DEFAULT 1 COMMENT '回复类型: 1-文本 2-图文 3-链接 4-小程序',
    reply_content TEXT NOT NULL COMMENT '回复内容',
    media_url VARCHAR(255) COMMENT '媒体URL',
    
    -- 生效配置
    effective_time_start TIME COMMENT '生效开始时间',
    effective_time_end TIME COMMENT '生效结束时间',
    trigger_limit INT DEFAULT 0 COMMENT '触发限制(0表示无限制)',
    priority INT DEFAULT 0 COMMENT '优先级(数字越大优先级越高)',
    
    status TINYINT DEFAULT 1 COMMENT '状态: 0-禁用 1-启用',
    create_by BIGINT COMMENT '创建人',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_by BIGINT COMMENT '更新人',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    deleted TINYINT DEFAULT 0 COMMENT '删除标志',
    INDEX idx_group_id (group_id),
    INDEX idx_keyword (keyword),
    INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='关键词回复表';
```

#### 3.2.3 API管理相关表

##### API信息表 (api_info)

```sql
CREATE TABLE api_info (
    api_id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'API ID',
    api_code VARCHAR(128) NOT NULL UNIQUE COMMENT 'API编码',
    api_name VARCHAR(128) NOT NULL COMMENT 'API名称',
    api_category TINYINT NOT NULL COMMENT 'API分类: 1-企微API 2-业务API 3-第三方API',
    api_version VARCHAR(16) DEFAULT 'v1' COMMENT 'API版本',
    
    -- 请求信息
    http_method VARCHAR(16) NOT NULL COMMENT 'HTTP方法: GET/POST/PUT/DELETE/PATCH',
    api_path VARCHAR(255) NOT NULL COMMENT 'API路径',
    content_type VARCHAR(64) DEFAULT 'application/json' COMMENT 'Content-Type',
    
    -- 描述信息
    description TEXT COMMENT 'API描述',
    request_example TEXT COMMENT '请求示例',
    response_example TEXT COMMENT '响应示例',
    
    -- 企微API特有
    wechat_api_type VARCHAR(32) COMMENT '企微API类型',
    rate_limit INT COMMENT '频率限制(次/秒)',
    official_doc_url VARCHAR(255) COMMENT '官方文档链接',
    
    status TINYINT DEFAULT 1 COMMENT '状态: 1-开发中 2-测试中 3-已发布 4-已废弃',
    create_by BIGINT COMMENT '创建人',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_by BIGINT COMMENT '更新人',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    deleted TINYINT DEFAULT 0 COMMENT '删除标志',
    INDEX idx_api_category (api_category),
    INDEX idx_http_method (http_method),
    INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='API信息表';
```

##### API参数表 (api_param)

```sql
CREATE TABLE api_param (
    param_id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '参数ID',
    api_id BIGINT NOT NULL COMMENT 'API ID',
    param_name VARCHAR(64) NOT NULL COMMENT '参数名',
    param_location TINYINT NOT NULL COMMENT '参数位置: 1-Header 2-Query 3-Body 4-Path',
    param_type VARCHAR(32) NOT NULL COMMENT '参数类型: String/Number/Boolean/Object/Array',
    required TINYINT DEFAULT 0 COMMENT '是否必填: 0-否 1-是',
    default_value VARCHAR(255) COMMENT '默认值',
    description VARCHAR(255) COMMENT '参数描述',
    example_value VARCHAR(255) COMMENT '示例值',
    sort_order INT DEFAULT 0 COMMENT '排序',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    INDEX idx_api_id (api_id),
    INDEX idx_param_location (param_location)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='API参数表';
```

##### API调用日志表 (api_call_log)

```sql
CREATE TABLE api_call_log (
    log_id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '日志ID',
    api_id BIGINT COMMENT 'API ID',
    api_name VARCHAR(128) COMMENT 'API名称',
    api_path VARCHAR(255) COMMENT 'API路径',
    http_method VARCHAR(16) COMMENT 'HTTP方法',
    
    -- 请求信息
    request_headers TEXT COMMENT '请求头',
    request_params TEXT COMMENT '请求参数',
    request_body TEXT COMMENT '请求体',
    
    -- 响应信息
    response_status INT COMMENT '响应状态码',
    response_headers TEXT COMMENT '响应头',
    response_body TEXT COMMENT '响应体',
    
    -- 执行信息
    execution_time INT COMMENT '执行时长(ms)',
    call_status TINYINT COMMENT '调用状态: 0-失败 1-成功',
    error_msg TEXT COMMENT '错误信息',
    
    -- 调用者信息
    call_by BIGINT COMMENT '调用人ID',
    call_ip VARCHAR(64) COMMENT '调用IP',
    call_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '调用时间',
    INDEX idx_api_id (api_id),
    INDEX idx_call_by (call_by),
    INDEX idx_call_status (call_status),
    INDEX idx_call_time (call_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='API调用日志表';
```

#### 3.2.4 系统配置相关表

##### 系统参数表 (sys_config)

```sql
CREATE TABLE sys_config (
    config_id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '参数ID',
    config_key VARCHAR(128) NOT NULL UNIQUE COMMENT '参数键',
    config_value TEXT NOT NULL COMMENT '参数值',
    config_type TINYINT DEFAULT 1 COMMENT '参数类型: 1-字符串 2-数字 3-布尔 4-JSON',
    description VARCHAR(255) COMMENT '参数描述',
    is_system TINYINT DEFAULT 0 COMMENT '是否系统参数: 0-否 1-是',
    status TINYINT DEFAULT 1 COMMENT '状态: 0-禁用 1-启用',
    create_by BIGINT COMMENT '创建人',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_by BIGINT COMMENT '更新人',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    INDEX idx_config_key (config_key),
    INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='系统参数表';
```

##### 文件记录表 (sys_file)

```sql
CREATE TABLE sys_file (
    file_id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '文件ID',
    file_name VARCHAR(255) NOT NULL COMMENT '文件名称',
    original_name VARCHAR(255) COMMENT '原始文件名',
    file_suffix VARCHAR(16) COMMENT '文件后缀',
    file_size BIGINT COMMENT '文件大小(字节)',
    file_type VARCHAR(32) COMMENT '文件类型',
    file_path VARCHAR(255) COMMENT '文件路径',
    file_url VARCHAR(255) COMMENT '文件访问URL',
    storage_type TINYINT DEFAULT 1 COMMENT '存储类型: 1-本地 2-MinIO 3-OSS',
    
    -- 业务信息
    module VARCHAR(32) COMMENT '所属模块',
    business_type VARCHAR(32) COMMENT '业务类型',
    business_id BIGINT COMMENT '业务ID',
    
    create_by BIGINT COMMENT '上传人',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '上传时间',
    deleted TINYINT DEFAULT 0 COMMENT '删除标志',
    INDEX idx_module (module),
    INDEX idx_business (business_type, business_id),
    INDEX idx_create_time (create_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='文件记录表';
```

### 3.3 索引设计原则

1. **主键索引**：所有表必须有主键，使用自增ID
2. **唯一索引**：业务唯一字段建立唯一索引
3. **普通索引**：高频查询条件字段建立普通索引
4. **联合索引**：多条件查询建立联合索引，遵循最左前缀原则
5. **索引数量**：单表索引数量不超过10个
6. **索引字段**：避免对频繁更新的字段建立索引

---

## 4. 接口设计

### 4.1 接口规范

#### 4.1.1 基础规范

- **协议**：HTTPS
- **格式**：RESTful API
- **数据格式**：JSON
- **编码**：UTF-8
- **版本控制**：URL路径版本控制（/api/v1/）
- **认证方式**：JWT Token（Header: Authorization: Bearer {token}）

#### 4.1.2 响应格式

**成功响应**：
```json
{
    "code": 200,
    "message": "success",
    "data": {
        // 具体业务数据
    },
    "timestamp": 1706983800000,
    "requestId": "req_abc123"
}
```

**错误响应**：
```json
{
    "code": 400,
    "message": "参数错误",
    "error": {
        "errorCode": "0101001",
        "errorMsg": "用户名已存在",
        "field": "username"
    },
    "timestamp": 1706983800000,
    "requestId": "req_abc123"
}
```

**分页响应**：
```json
{
    "code": 200,
    "message": "success",
    "data": {
        "list": [],
        "pagination": {
            "pageNum": 1,
            "pageSize": 20,
            "total": 100,
            "pages": 5
        }
    },
    "timestamp": 1706983800000
}
```

### 4.2 用户权限模块接口

#### 4.2.1 用户管理接口

| 接口 | 方法 | 路径 | 描述 | 权限 |
|------|------|------|------|------|
| 用户登录 | POST | /api/v1/auth/login | 用户登录 | 公开 |
| 用户登出 | POST | /api/v1/auth/logout | 用户登出 | 登录用户 |
| 刷新Token | POST | /api/v1/auth/refresh | 刷新访问令牌 | 登录用户 |
| 获取用户信息 | GET | /api/v1/auth/info | 获取当前用户信息 | 登录用户 |
| 用户列表 | GET | /api/v1/users | 分页查询用户列表 | user:view |
| 用户详情 | GET | /api/v1/users/{userId} | 获取用户详情 | user:view |
| 创建用户 | POST | /api/v1/users | 创建新用户 | user:create |
| 更新用户 | PUT | /api/v1/users/{userId} | 更新用户信息 | user:update |
| 删除用户 | DELETE | /api/v1/users/{userId} | 删除用户 | user:delete |
| 重置密码 | PUT | /api/v1/users/{userId}/password/reset | 重置用户密码 | user:update |
| 修改密码 | PUT | /api/v1/users/password | 修改当前用户密码 | 登录用户 |
| 批量导入 | POST | /api/v1/users/import | 批量导入用户 | user:create |
| 批量导出 | GET | /api/v1/users/export | 批量导出用户 | user:view |

**用户登录接口示例**：

```http
POST /api/v1/auth/login
Content-Type: application/json

{
    "username": "admin",
    "password": "123456",
    "captcha": "a3f5",
    "captchaKey": "captcha_key_001"
}
```

响应：
```json
{
    "code": 200,
    "message": "success",
    "data": {
        "accessToken": "eyJhbGciOiJIUzI1NiIs...",
        "refreshToken": "eyJhbGciOiJIUzI1NiIs...",
        "expiresIn": 7200,
        "tokenType": "Bearer",
        "user": {
            "userId": 1,
            "username": "admin",
            "realName": "管理员",
            "avatar": "https://example.com/avatar.jpg",
            "roles": ["ROLE_ADMIN"],
            "permissions": ["user:view", "user:create"]
        }
    }
}
```

#### 4.2.2 角色管理接口

| 接口 | 方法 | 路径 | 描述 | 权限 |
|------|------|------|------|------|
| 角色列表 | GET | /api/v1/roles | 查询角色列表 | role:view |
| 角色详情 | GET | /api/v1/roles/{roleId} | 获取角色详情 | role:view |
| 创建角色 | POST | /api/v1/roles | 创建角色 | role:create |
| 更新角色 | PUT | /api/v1/roles/{roleId} | 更新角色 | role:update |
| 删除角色 | DELETE | /api/v1/roles/{roleId} | 删除角色 | role:delete |
| 配置权限 | PUT | /api/v1/roles/{roleId}/permissions | 配置角色权限 | role:update |
| 获取权限树 | GET | /api/v1/roles/{roleId}/permissions | 获取角色权限树 | role:view |

#### 4.2.3 权限管理接口

| 接口 | 方法 | 路径 | 描述 | 权限 |
|------|------|------|------|------|
| 权限列表 | GET | /api/v1/permissions | 查询权限列表 | permission:view |
| 权限树 | GET | /api/v1/permissions/tree | 获取权限树 | permission:view |
| 创建权限 | POST | /api/v1/permissions | 创建权限 | permission:create |
| 更新权限 | PUT | /api/v1/permissions/{permissionId} | 更新权限 | permission:update |
| 删除权限 | DELETE | /api/v1/permissions/{permissionId} | 删除权限 | permission:delete |

#### 4.2.4 部门管理接口

| 接口 | 方法 | 路径 | 描述 | 权限 |
|------|------|------|------|------|
| 部门树 | GET | /api/v1/depts/tree | 获取部门树 | dept:view |
| 部门列表 | GET | /api/v1/depts | 查询部门列表 | dept:view |
| 部门详情 | GET | /api/v1/depts/{deptId} | 获取部门详情 | dept:view |
| 创建部门 | POST | /api/v1/depts | 创建部门 | dept:create |
| 更新部门 | PUT | /api/v1/depts/{deptId} | 更新部门 | dept:update |
| 删除部门 | DELETE | /api/v1/depts/{deptId} | 删除部门 | dept:delete |

### 4.3 社群管理模块接口

#### 4.3.1 社群管理接口

| 接口 | 方法 | 路径 | 描述 | 权限 |
|------|------|------|------|------|
| 社群列表 | GET | /api/v1/groups | 分页查询社群列表 | group:view |
| 社群详情 | GET | /api/v1/groups/{groupId} | 获取社群详情 | group:view |
| 创建社群 | POST | /api/v1/groups | 创建社群 | group:create |
| 更新社群 | PUT | /api/v1/groups/{groupId} | 更新社群 | group:update |
| 解散社群 | DELETE | /api/v1/groups/{groupId} | 解散社群 | group:delete |
| 获取入群二维码 | GET | /api/v1/groups/{groupId}/qrcode | 获取入群二维码 | group:view |
| 群发消息 | POST | /api/v1/groups/broadcast | 向多个社群群发消息 | group:broadcast |
| 社群统计 | GET | /api/v1/groups/statistics | 获取社群统计数据 | group:view |

**创建社群接口示例**：

```http
POST /api/v1/groups
Content-Type: application/json
Authorization: Bearer {token}

{
    "groupName": "高血压管理群",
    "groupType": 2,
    "description": "专为高血压患者提供健康管理服务",
    "tagIds": [1, 3, 5],
    "doctorId": 10,
    "healthManagerId": 0,
    "benefitAdvisorId": 15,
    "insuranceAdvisorId": 20,
    "joinType": 1,
    "welcomeMsg": "欢迎加入高血压管理群！请填写健康档案。",
    "welcomeFormId": 5,
    "adFilter": 1,
    "sensitiveWords": "广告,推销,诈骗"
}
```

#### 4.3.2 成员管理接口

| 接口 | 方法 | 路径 | 描述 | 权限 |
|------|------|------|------|------|
| 成员列表 | GET | /api/v1/groups/{groupId}/members | 查询社群成员列表 | group:member:view |
| 成员详情 | GET | /api/v1/groups/{groupId}/members/{memberId} | 获取成员详情 | group:member:view |
| 添加成员 | POST | /api/v1/groups/{groupId}/members | 添加成员到社群 | group:member:create |
| 移除成员 | DELETE | /api/v1/groups/{groupId}/members/{memberId} | 移除社群成员 | group:member:delete |
| 批量移除 | POST | /api/v1/groups/{groupId}/members/batch-remove | 批量移除成员 | group:member:delete |
| 设置禁言 | PUT | /api/v1/groups/{groupId}/members/{memberId}/mute | 设置成员禁言 | group:member:update |
| 取消禁言 | PUT | /api/v1/groups/{groupId}/members/{memberId}/unmute | 取消成员禁言 | group:member:update |
| 设置管理员 | PUT | /api/v1/groups/{groupId}/members/{memberId}/admin | 设置成员为管理员 | group:member:update |
| 导出成员 | GET | /api/v1/groups/{groupId}/members/export | 导出成员列表 | group:member:view |

#### 4.3.3 关键词回复接口

| 接口 | 方法 | 路径 | 描述 | 权限 |
|------|------|------|------|------|
| 回复规则列表 | GET | /api/v1/groups/keyword-replies | 查询关键词回复规则 | keyword:view |
| 回复规则详情 | GET | /api/v1/groups/keyword-replies/{replyId} | 获取回复规则详情 | keyword:view |
| 创建回复规则 | POST | /api/v1/groups/keyword-replies | 创建关键词回复规则 | keyword:create |
| 更新回复规则 | PUT | /api/v1/groups/keyword-replies/{replyId} | 更新关键词回复规则 | keyword:update |
| 删除回复规则 | DELETE | /api/v1/groups/keyword-replies/{replyId} | 删除关键词回复规则 | keyword:delete |
| 批量启用/禁用 | PUT | /api/v1/groups/keyword-replies/batch-status | 批量修改规则状态 | keyword:update |

### 4.4 API管理模块接口

#### 4.4.1 API信息管理接口

| 接口 | 方法 | 路径 | 描述 | 权限 |
|------|------|------|------|------|
| API列表 | GET | /api/v1/apis | 分页查询API列表 | api:view |
| API详情 | GET | /api/v1/apis/{apiId} | 获取API详情 | api:view |
| 创建API | POST | /api/v1/apis | 创建API信息 | api:create |
| 更新API | PUT | /api/v1/apis/{apiId} | 更新API信息 | api:update |
| 删除API | DELETE | /api/v1/apis/{apiId} | 删除API | api:delete |
| 发布API | PUT | /api/v1/apis/{apiId}/publish | 发布API | api:update |
| 废弃API | PUT | /api/v1/apis/{apiId}/deprecate | 废弃API | api:update |
| 导入企微API | POST | /api/v1/apis/import-wechat | 导入企业微信API | api:create |
| 生成文档 | GET | /api/v1/apis/{apiId}/docs | 生成API文档 | api:view |
| 导出文档 | GET | /api/v1/apis/{apiId}/docs/export | 导出API文档 | api:view |

#### 4.4.2 API测试接口

| 接口 | 方法 | 路径 | 描述 | 权限 |
|------|------|------|------|------|
| 测试API | POST | /api/v1/apis/{apiId}/test | 在线测试API | api:test |
| 获取测试环境 | GET | /api/v1/apis/environments | 获取测试环境列表 | api:test |
| 保存测试用例 | POST | /api/v1/apis/{apiId}/test-cases | 保存测试用例 | api:test |
| 获取测试历史 | GET | /api/v1/apis/{apiId}/test-history | 获取测试历史 | api:test |

**API测试接口示例**：

```http
POST /api/v1/apis/100/test
Content-Type: application/json
Authorization: Bearer {token}

{
    "environment": "development",
    "headers": {
        "Content-Type": "application/json"
    },
    "params": {
        "access_token": "your_access_token"
    },
    "body": {
        "userid": "zhangsan"
    }
}
```

响应：
```json
{
    "code": 200,
    "message": "success",
    "data": {
        "request": {
            "url": "https://qyapi.weixin.qq.com/cgi-bin/externalcontact/list",
            "method": "GET",
            "headers": {},
            "params": {"access_token": "your_access_token"}
        },
        "response": {
            "status": 200,
            "statusText": "OK",
            "headers": {},
            "body": {
                "errcode": 0,
                "errmsg": "ok",
                "external_userid": ["woxxxx"]
            },
            "responseTime": 120
        }
    }
}
```

#### 4.4.3 API统计分析接口

| 接口 | 方法 | 路径 | 描述 | 权限 |
|------|------|------|------|------|
| 调用统计 | GET | /api/v1/apis/statistics/calls | 获取API调用统计 | api:stats:view |
| 性能统计 | GET | /api/v1/apis/statistics/performance | 获取API性能统计 | api:stats:view |
| 错误统计 | GET | /api/v1/apis/statistics/errors | 获取API错误统计 | api:stats:view |
| 调用日志 | GET | /api/v1/apis/call-logs | 查询API调用日志 | api:log:view |

### 4.5 系统管理模块接口

#### 4.5.1 系统配置接口

| 接口 | 方法 | 路径 | 描述 | 权限 |
|------|------|------|------|------|
| 配置列表 | GET | /api/v1/system/configs | 查询系统配置列表 | config:view |
| 配置详情 | GET | /api/v1/system/configs/{configKey} | 根据key获取配置 | config:view |
| 创建配置 | POST | /api/v1/system/configs | 创建系统配置 | config:create |
| 更新配置 | PUT | /api/v1/system/configs/{configKey} | 更新系统配置 | config:update |
| 删除配置 | DELETE | /api/v1/system/configs/{configKey} | 删除系统配置 | config:delete |
| 刷新缓存 | POST | /api/v1/system/configs/refresh | 刷新配置缓存 | config:update |

#### 4.5.2 文件管理接口

| 接口 | 方法 | 路径 | 描述 | 权限 |
|------|------|------|------|------|
| 文件上传 | POST | /api/v1/system/files/upload | 上传文件 | file:upload |
| 文件下载 | GET | /api/v1/system/files/{fileId}/download | 下载文件 | file:download |
| 文件列表 | GET | /api/v1/system/files | 查询文件列表 | file:view |
| 删除文件 | DELETE | /api/v1/system/files/{fileId} | 删除文件 | file:delete |
| 批量删除 | POST | /api/v1/system/files/batch-delete | 批量删除文件 | file:delete |

#### 4.5.3 操作日志接口

| 接口 | 方法 | 路径 | 描述 | 权限 |
|------|------|------|------|------|
| 日志列表 | GET | /api/v1/system/logs/operation | 查询操作日志 | log:view |
| 日志详情 | GET | /api/v1/system/logs/operation/{logId} | 获取日志详情 | log:view |
| 导出日志 | GET | /api/v1/system/logs/operation/export | 导出操作日志 | log:view |
| 清空日志 | DELETE | /api/v1/system/logs/operation/clear | 清空历史日志 | log:delete |

---

## 5. 核心功能开发指南

### 5.1 RBAC权限控制实现

#### 5.1.1 权限注解

```java
@Target({ElementType.METHOD, ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
public @interface RequiresPermissions {
    String[] value();
    Logical logical() default Logical.AND;
}

public enum Logical {
    AND, OR
}
```

#### 5.1.2 权限切面

```java
@Aspect
@Component
@Slf4j
public class PermissionAspect {

    @Autowired
    private PermissionService permissionService;

    @Around("@annotation(requiresPermissions)")
    public Object around(ProceedingJoinPoint point, RequiresPermissions requiresPermissions) throws Throwable {
        // 获取当前用户
        Long userId = SecurityUtils.getCurrentUserId();
        
        // 获取所需权限
        String[] permissions = requiresPermissions.value();
        Logical logical = requiresPermissions.logical();
        
        // 校验权限
        boolean hasPermission;
        if (logical == Logical.AND) {
            hasPermission = permissionService.hasAllPermissions(userId, permissions);
        } else {
            hasPermission = permissionService.hasAnyPermission(userId, permissions);
        }
        
        if (!hasPermission) {
            throw new AccessDeniedException("无权访问该资源");
        }
        
        return point.proceed();
    }
}
```

#### 5.1.3 数据权限实现

```java
@Component
public class DataScopeAspect {

    @Before("@annotation(dataScope)")
    public void before(JoinPoint point, DataScope dataScope) {
        // 获取当前用户的数据范围
        Long userId = SecurityUtils.getCurrentUserId();
        DataScopeType dataScopeType = userService.getDataScope(userId);
        
        // 根据数据范围设置查询条件
        if (dataScopeType == DataScopeType.DEPT) {
            // 获取用户部门及子部门ID列表
            List<Long> deptIds = deptService.getChildDeptIds(userId);
            DataScopeContext.setDeptIds(deptIds);
        } else if (dataScopeType == DataScopeType.SELF) {
            DataScopeContext.setUserId(userId);
        }
    }
}
```

### 5.2 企业微信API调用封装

#### 5.2.1 企微服务客户端

```java
@Service
@Slf4j
public class WechatWorkService {

    @Autowired
    private RestTemplate restTemplate;
    @Autowired
    private WechatWorkProperties properties;
    @Autowired
    private RedisTemplate<String, String> redisTemplate;

    private static final String ACCESS_TOKEN_KEY = "wechat:access_token";
    private static final long TOKEN_EXPIRE_TIME = 7200; // 2小时

    /**
     * 获取AccessToken
     */
    public String getAccessToken() {
        String token = redisTemplate.opsForValue().get(ACCESS_TOKEN_KEY);
        if (StrUtil.isNotBlank(token)) {
            return token;
        }
        
        String url = String.format(
            "https://qyapi.weixin.qq.com/cgi-bin/gettoken?corpid=%s&corpsecret=%s",
            properties.getCorpId(),
            properties.getCorpSecret()
        );
        
        WechatResponse response = restTemplate.getForObject(url, WechatResponse.class);
        if (response != null && response.getErrcode() == 0) {
            token = response.getAccessToken();
            redisTemplate.opsForValue().set(ACCESS_TOKEN_KEY, token, TOKEN_EXPIRE_TIME - 300, TimeUnit.SECONDS);
            return token;
        }
        
        throw new BusinessException("获取企微AccessToken失败: " + response.getErrmsg());
    }

    /**
     * 创建群聊
     */
    public String createGroupChat(GroupChatCreateRequest request) {
        String url = "https://qyapi.weixin.qq.com/cgi-bin/appchat/create?access_token=" + getAccessToken();
        
        WechatResponse response = restTemplate.postForObject(url, request, WechatResponse.class);
        if (response != null && response.getErrcode() == 0) {
            return response.getChatId();
        }
        
        throw new BusinessException("创建群聊失败: " + response.getErrmsg());
    }

    /**
     * 发送群消息
     */
    public void sendGroupMessage(String chatId, Message message) {
        String url = "https://qyapi.weixin.qq.com/cgi-bin/appchat/send?access_token=" + getAccessToken();
        
        GroupMessageRequest request = new GroupMessageRequest();
        request.setChatId(chatId);
        request.setMsgType(message.getType());
        request.setText(message.getText());
        
        WechatResponse response = restTemplate.postForObject(url, request, WechatResponse.class);
        if (response == null || response.getErrcode() != 0) {
            throw new BusinessException("发送群消息失败: " + (response != null ? response.getErrmsg() : "未知错误"));
        }
    }
}
```

#### 5.2.2 消息回调处理

```java
@RestController
@RequestMapping("/api/v1/wechat/callback")
@Slf4j
public class WechatCallbackController {

    @Autowired
    private WechatCallbackService callbackService;
    @Autowired
    private WechatWorkProperties properties;

    /**
     * 验证URL有效性
     */
    @GetMapping
    public String verifyUrl(
            @RequestParam("msg_signature") String signature,
            @RequestParam("timestamp") String timestamp,
            @RequestParam("nonce") String nonce,
            @RequestParam("echostr") String echostr) {
        
        try {
            WXBizMsgCrypt crypt = new WXBizMsgCrypt(
                properties.getToken(),
                properties.getEncodingAesKey(),
                properties.getCorpId()
            );
            return crypt.verifyUrl(signature, timestamp, nonce, echostr);
        } catch (Exception e) {
            log.error("验证URL失败", e);
            return "fail";
        }
    }

    /**
     * 接收消息回调
     */
    @PostMapping
    public String receiveMessage(
            @RequestParam("msg_signature") String signature,
            @RequestParam("timestamp") String timestamp,
            @RequestParam("nonce") String nonce,
            @RequestBody String requestBody) {
        
        try {
            // 解密消息
            WXBizMsgCrypt crypt = new WXBizMsgCrypt(
                properties.getToken(),
                properties.getEncodingAesKey(),
                properties.getCorpId()
            );
            String decryptMsg = crypt.decryptMsg(signature, timestamp, nonce, requestBody);
            
            // 解析消息
            WechatMessage message = parseMessage(decryptMsg);
            
            // 异步处理消息
            callbackService.handleMessage(message);
            
            return "success";
        } catch (Exception e) {
            log.error("处理消息回调失败", e);
            return "fail";
        }
    }
}
```

### 5.3 API在线测试实现

#### 5.3.1 API测试服务

```java
@Service
@Slf4j
public class ApiTestService {

    @Autowired
    private RestTemplate restTemplate;
    @Autowired
    private ApiInfoService apiInfoService;

    /**
     * 执行API测试
     */
    public ApiTestResult testApi(Long apiId, ApiTestRequest request) {
        ApiInfo api = apiInfoService.getById(apiId);
        if (api == null) {
            throw new BusinessException("API不存在");
        }

        // 构建请求URL
        String baseUrl = getBaseUrl(request.getEnvironment());
        String url = baseUrl + api.getApiPath();

        // 构建请求头
        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.parseMediaType(api.getContentType()));
        if (request.getHeaders() != null) {
            request.getHeaders().forEach(headers::set);
        }

        // 构建请求参数
        UriComponentsBuilder uriBuilder = UriComponentsBuilder.fromHttpUrl(url);
        if (request.getParams() != null) {
            request.getParams().forEach(uriBuilder::queryParam);
        }

        // 执行请求
        long startTime = System.currentTimeMillis();
        HttpEntity<String> entity = new HttpEntity<>(request.getBody(), headers);
        
        ResponseEntity<String> response;
        try {
            response = restTemplate.exchange(
                uriBuilder.toUriString(),
                HttpMethod.valueOf(api.getHttpMethod()),
                entity,
                String.class
            );
        } catch (Exception e) {
            log.error("API测试失败", e);
            return buildErrorResult(e, startTime);
        }

        long endTime = System.currentTimeMillis();

        // 构建测试结果
        ApiTestResult result = new ApiTestResult();
        result.setRequest(buildRequestInfo(url, headers, request));
        result.setResponse(buildResponseInfo(response, endTime - startTime));
        
        return result;
    }

    private String getBaseUrl(String environment) {
        switch (environment) {
            case "development":
                return "http://localhost:8080";
            case "testing":
                return "https://api-test.example.com";
            case "production":
                return "https://api.example.com";
            default:
                return "http://localhost:8080";
        }
    }
}
```

### 5.4 数据统计实现

#### 5.4.1 统计服务

```java
@Service
@Slf4j
public class StatisticsService {

    @Autowired
    private UserMapper userMapper;
    @Autowired
    private GroupMapper groupMapper;
    @Autowired
    private StringRedisTemplate redisTemplate;

    /**
     * 获取用户统计数据
     */
    public UserStatisticsVO getUserStatistics(StatisticsQuery query) {
        UserStatisticsVO vo = new UserStatisticsVO();
        
        // 总用户数
        Long totalUsers = userMapper.selectCount(
            new LambdaQueryWrapper<SysUser>()
                .eq(SysUser::getDeleted, 0)
        );
        vo.setTotalUsers(totalUsers);
        
        // 新增用户数
        Long newUsers = userMapper.selectCount(
            new LambdaQueryWrapper<SysUser>()
                .eq(SysUser::getDeleted, 0)
                .ge(SysUser::getCreateTime, query.getStartTime())
                .le(SysUser::getCreateTime, query.getEndTime())
        );
        vo.setNewUsers(newUsers);
        
        // 活跃用户
        Long activeUsers = getActiveUsers(query.getStartTime(), query.getEndTime());
        vo.setActiveUsers(activeUsers);
        
        // 留存率
        Double retentionRate = calculateRetentionRate(query);
        vo.setRetentionRate(retentionRate);
        
        // 趋势数据
        List<TrendData> trends = getUserTrend(query);
        vo.setTrends(trends);
        
        return vo;
    }

    /**
     * 获取社群统计数据
     */
    public GroupStatisticsVO getGroupStatistics(StatisticsQuery query) {
        GroupStatisticsVO vo = new GroupStatisticsVO();
        
        // 社群总数
        Long totalGroups = groupMapper.selectCount(
            new LambdaQueryWrapper<GroupInfo>()
                .eq(GroupInfo::getDeleted, 0)
        );
        vo.setTotalGroups(totalGroups);
        
        // 活跃社群数
        Long activeGroups = groupMapper.selectActiveGroupCount(query);
        vo.setActiveGroups(activeGroups);
        
        // 总成员数
        Long totalMembers = groupMapper.selectTotalMemberCount();
        vo.setTotalMembers(totalMembers);
        
        // 活跃度排行
        List<GroupActivityRank> ranks = groupMapper.selectActivityRank(10);
        vo.setActivityRanks(ranks);
        
        return vo;
    }
}
```

---

## 6. 安全设计

### 6.1 认证授权

#### 6.1.1 JWT Token配置

```java
@Configuration
@ConfigurationProperties(prefix = "jwt")
@Data
public class JwtProperties {
    private String secret;
    private long accessTokenExpiration = 7200000; // 2小时
    private long refreshTokenExpiration = 604800000; // 7天
}

@Component
public class JwtTokenProvider {

    @Autowired
    private JwtProperties jwtProperties;

    private SecretKey key;

    @PostConstruct
    public void init() {
        this.key = Keys.hmacShaKeyFor(jwtProperties.getSecret().getBytes());
    }

    public String generateAccessToken(Long userId, String username, Collection<? extends GrantedAuthority> authorities) {
        Date now = new Date();
        Date expiryDate = new Date(now.getTime() + jwtProperties.getAccessTokenExpiration());

        return Jwts.builder()
                .setSubject(String.valueOf(userId))
                .claim("username", username)
                .claim("authorities", authorities.stream()
                        .map(GrantedAuthority::getAuthority)
                        .collect(Collectors.toList()))
                .setIssuedAt(now)
                .setExpiration(expiryDate)
                .signWith(key)
                .compact();
    }

    public boolean validateToken(String token) {
        try {
            Jwts.parserBuilder().setSigningKey(key).build().parseClaimsJws(token);
            return true;
        } catch (Exception e) {
            return false;
        }
    }

    public Claims getClaimsFromToken(String token) {
        return Jwts.parserBuilder()
                .setSigningKey(key)
                .build()
                .parseClaimsJws(token)
                .getBody();
    }
}
```

### 6.2 接口安全

#### 6.2.1 接口签名验证

```java
@Component
public class ApiSignatureFilter extends OncePerRequestFilter {

    @Autowired
    private SignatureService signatureService;

    @Override
    protected void doFilterInternal(HttpServletRequest request, 
                                    HttpServletResponse response, 
                                    FilterChain filterChain) throws ServletException, IOException {
        
        // 获取签名参数
        String signature = request.getHeader("X-Signature");
        String timestamp = request.getHeader("X-Timestamp");
        String nonce = request.getHeader("X-Nonce");
        
        // 验证时间戳（5分钟内有效）
        long now = System.currentTimeMillis() / 1000;
        long reqTime = Long.parseLong(timestamp);
        if (Math.abs(now - reqTime) > 300) {
            throw new SignatureException("请求已过期");
        }
        
        // 验证签名
        String body = getRequestBody(request);
        String expectedSign = signatureService.generateSignature(timestamp, nonce, body);
        
        if (!expectedSign.equals(signature)) {
            throw new SignatureException("签名验证失败");
        }
        
        filterChain.doFilter(request, response);
    }
}
```

### 6.3 数据安全

#### 6.3.1 敏感数据脱敏

```java
@Component
public class DataDesensitizeAspect {

    @Around("execution(* com.healthcare.admin..controller..*.*(..))")
    public Object around(ProceedingJoinPoint point) throws Throwable {
        Object result = point.proceed();
        
        if (result instanceof Result) {
            Result<?> r = (Result<?>) result;
            if (r.getData() != null) {
                desensitize(r.getData());
            }
        }
        
        return result;
    }

    private void desensitize(Object obj) {
        if (obj == null) return;
        
        Class<?> clazz = obj.getClass();
        for (Field field : clazz.getDeclaredFields()) {
            Desensitize annotation = field.getAnnotation(Desensitize.class);
            if (annotation != null) {
                try {
                    field.setAccessible(true);
                    Object value = field.get(obj);
                    if (value instanceof String) {
                        String desensitized = desensitizeValue((String) value, annotation.type());
                        field.set(obj, desensitized);
                    }
                } catch (IllegalAccessException e) {
                    log.error("脱敏处理失败", e);
                }
            }
        }
    }

    private String desensitizeValue(String value, DesensitizeType type) {
        switch (type) {
            case PHONE:
                return value.replaceAll("(\\d{3})\\d{4}(\\d{4})", "$1****$2");
            case EMAIL:
                return value.replaceAll("(\\w{2})\\w+(@\\w+)", "$1****$2");
            case ID_CARD:
                return value.replaceAll("(\\d{6})\\d{8}(\\d{4})", "$1********$2");
            default:
                return value;
        }
    }
}
```

---

## 7. 部署方案

### 7.1 环境要求

| 环境 | 配置 | 数量 |
|------|------|------|
| 开发环境 | 4核8G | 1台 |
| 测试环境 | 4核8G | 2台 |
| 生产环境 | 8核16G | 4台 |

### 7.2 Docker部署

#### 7.2.1 Dockerfile

```dockerfile
# 构建阶段
FROM maven:3.9-eclipse-temurin-17-alpine AS builder
WORKDIR /app
COPY pom.xml .
COPY src ./src
RUN mvn clean package -DskipTests

# 运行阶段
FROM eclipse-temurin:17-jre-alpine
WORKDIR /app
COPY --from=builder /app/target/*.jar app.jar

EXPOSE 8080

ENTRYPOINT ["java", "-jar", "app.jar"]
```

#### 7.2.2 Docker Compose

```yaml
version: '3.8'

services:
  # MySQL
  mysql:
    image: mysql:8.0
    container_name: healthcare-mysql
    environment:
      MYSQL_ROOT_PASSWORD: <your-root-password>
      MYSQL_DATABASE: healthcare_admin
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./sql/init.sql:/docker-entrypoint-initdb.d/init.sql

  # Redis
  redis:
    image: redis:7-alpine
    container_name: healthcare-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  # RabbitMQ
  rabbitmq:
    image: rabbitmq:3.12-management
    container_name: healthcare-rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: admin123

  # 应用服务
  app:
    build: .
    container_name: healthcare-app
    ports:
      - "8080:8080"
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/healthcare_admin?useUnicode=true&characterEncoding=utf-8
      SPRING_REDIS_HOST: redis
      SPRING_RABBITMQ_HOST: rabbitmq
    depends_on:
      - mysql
      - redis
      - rabbitmq

volumes:
  mysql_data:
  redis_data:
```

### 7.3 Kubernetes部署

#### 7.3.1 Deployment配置

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: healthcare-admin
  namespace: healthcare
spec:
  replicas: 3
  selector:
    matchLabels:
      app: healthcare-admin
  template:
    metadata:
      labels:
        app: healthcare-admin
    spec:
      containers:
        - name: app
          image: registry.example.com/healthcare/admin:latest
          ports:
            - containerPort: 8080
          env:
            - name: SPRING_PROFILES_ACTIVE
              value: "prod"
            - name: JAVA_OPTS
              value: "-Xms512m -Xmx1024m"
          resources:
            requests:
              memory: "512Mi"
              cpu: "500m"
            limits:
              memory: "1024Mi"
              cpu: "1000m"
          livenessProbe:
            httpGet:
              path: /actuator/health/liveness
              port: 8080
            initialDelaySeconds: 60
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /actuator/health/readiness
              port: 8080
            initialDelaySeconds: 30
            periodSeconds: 5
```

---

## 8. 开发规范

### 8.1 代码规范

#### 8.1.1 Java代码规范

- 遵循阿里巴巴Java开发手册
- 使用Lombok简化代码
- 统一异常处理
- 日志规范：使用SLF4J + Logback
- 单元测试覆盖率≥80%

#### 8.1.2 命名规范

| 类型 | 规范 | 示例 |
|------|------|------|
| 类名 | 帕斯卡命名 | UserService |
| 方法名 | 驼峰命名 | getUserById |
| 变量名 | 驼峰命名 | userName |
| 常量名 | 大写下划线 | MAX_RETRY_COUNT |
| 数据库表名 | 小写下划线 | sys_user |
| 接口URL | 小写连字符 | /api/v1/user-info |

### 8.2 Git规范

#### 8.2.1 分支管理

- main：主分支，稳定版本
- develop：开发分支
- feature/*：功能分支
- hotfix/*：紧急修复分支
- release/*：发布分支

#### 8.2.2 提交规范

```
<type>(<scope>): <subject>

<body>

<footer>
```

Type类型：
- feat：新功能
- fix：修复
- docs：文档
- style：格式
- refactor：重构
- test：测试
- chore：构建

---

## 9. 测试方案

### 9.1 单元测试

```java
@SpringBootTest
class UserServiceTest {

    @Autowired
    private UserService userService;

    @MockBean
    private UserMapper userMapper;

    @Test
    void testCreateUser() {
        // Given
        UserCreateDTO dto = new UserCreateDTO();
        dto.setUsername("test");
        dto.setPassword("123456");
        
        when(userMapper.insert(any())).thenReturn(1);
        
        // When
        UserVO result = userService.createUser(dto);
        
        // Then
        assertNotNull(result);
        assertEquals("test", result.getUsername());
    }
}
```

### 9.2 接口测试

使用Postman/Newman进行接口自动化测试。

### 9.3 性能测试

使用JMeter进行性能测试，指标要求：
- 接口响应时间≤1秒（95%）
- 并发用户数≥1000
- 系统资源使用率≤80%

---

## 10. 附录

### 10.1 错误码表

| 错误码 | 错误信息 | 说明 |
|--------|---------|------|
| 0001001 | 参数不能为空 | 通用参数校验错误 |
| 0001002 | 参数格式错误 | 参数格式不符合要求 |
| 0101001 | 用户名已存在 | 用户创建错误 |
| 0101002 | 用户不存在 | 用户查询错误 |
| 0101003 | 密码错误 | 登录密码错误 |
| 0101004 | 账号已禁用 | 用户账号被禁用 |
| 0201001 | 社群名称不能为空 | 社群创建参数错误 |
| 0201002 | 社群不存在 | 社群查询错误 |
| 0301001 | API路径不能为空 | API录入参数错误 |
| 0404001 | 无权访问该资源 | 权限不足 |
| 0404002 | 登录已过期 | Token过期 |
| 0505001 | 系统繁忙 | 系统异常 |

### 10.2 配置参数表

| 参数名 | 默认值 | 说明 |
|--------|--------|------|
| jwt.secret | - | JWT密钥 |
| jwt.access-token-expiration | 7200000 | AccessToken过期时间(ms) |
| jwt.refresh-token-expiration | 604800000 | RefreshToken过期时间(ms) |
| wechat.corp-id | - | 企业微信CorpID |
| wechat.corp-secret | - | 企业微信Secret |
| file.max-size | 10485760 | 文件上传大小限制(10MB) |
| file.allowed-types | - | 允许的文件类型 |

### 10.3 变更记录

| 版本 | 日期 | 变更内容 | 变更人 |
|------|------|---------|--------|
| V1.0 | 2026-02-04 | 初始版本 | 技术团队 |

---

**文档结束**
